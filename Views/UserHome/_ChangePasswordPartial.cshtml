@model pet_spa_system1.ViewModel.ChangePasswordViewModel

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<form id="change-password-form" method="post">
    <div class="card shadow p-4" style="width:50%; margin:auto;">
        <h4 class="mb-3">Đổi Mật Khẩu</h4>

        <div class="mb-3">
            <label for="CurrentPassword" class="form-label fw-bold">Mật khẩu hiện tại</label>
            <input type="password" class="form-control" id="CurrentPassword" name="CurrentPassword" placeholder="Để trống nếu chưa có mật khẩu" />
        </div>

        <div class="mb-3">
            <label for="NewPassword" class="form-label fw-bold">Mật khẩu mới <span class="text-danger">*</span></label>
            <input type="password" class="form-control" id="NewPassword" name="NewPassword" required />
        </div>

        <div class="mb-3">
            <label for="ConfirmPassword" class="form-label fw-bold">Xác nhận mật khẩu mới <span class="text-danger">*</span></label>
            <input type="password" class="form-control" id="ConfirmPassword" name="ConfirmPassword" required />
        </div>

        <div class="d-flex justify-content-end gap-2">
            <button type="submit" class="btn btn-primary">Cập nhật</button>
            <button type="reset" class="btn btn-secondary">Hủy</button>
        </div>
    </div>
</form>

<script>
    document.getElementById('change-password-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Get form data
        var formData = new FormData(this);
        
        // Client-side validation
        var currentPassword = document.getElementById('CurrentPassword').value;
        var newPassword = document.getElementById('NewPassword').value;
        var confirmPassword = document.getElementById('ConfirmPassword').value;
        
        if (!newPassword || !confirmPassword) {
            Swal.fire({
                icon: 'error',
                title: 'Lỗi',
                text: 'Vui lòng điền mật khẩu mới và xác nhận mật khẩu.',
                confirmButtonText: 'Đồng ý'
            });
            return;
        }
        
        if (newPassword !== confirmPassword) {
            Swal.fire({
                icon: 'error',
                title: 'Lỗi',
                text: 'Mật khẩu xác nhận không khớp.',
                confirmButtonText: 'Đồng ý'
            });
            return;
        }
        
        if (newPassword.length < 6) {
            Swal.fire({
                icon: 'error',
                title: 'Lỗi',
                text: 'Mật khẩu mới phải có ít nhất 6 ký tự.',
                confirmButtonText: 'Đồng ý'
            });
            return;
        }
        
        // Show loading
        Swal.fire({
            title: 'Đang xử lý...',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        fetch('@Url.Action("ChangePassword", "UserHome")', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            Swal.close();
            
            if (data && data.success) {
                // Show success message
                Swal.fire({
                    icon: 'success',
                    title: 'Thành công',
                    text: data.message || 'Đổi mật khẩu thành công!',
                    confirmButtonText: 'Đồng ý'
                }).then(() => {
                    // Reset form
                    document.getElementById('change-password-form').reset();
                });
            } else {
                // Show error message
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: data.message || 'Có lỗi xảy ra khi đổi mật khẩu',
                    confirmButtonText: 'Đồng ý'
                });
            }
        })
        .catch(error => {
            Swal.close();
            console.error('Lỗi khi gửi form:', error);
            Swal.fire({
                icon: 'error',
                title: 'Lỗi',
                text: 'Không nhận được phản hồi hợp lệ từ server',
                confirmButtonText: 'Đồng ý'
            });
        });
    });
</script>
