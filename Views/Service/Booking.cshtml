@model pet_spa_system1.Models.BookingViewModel
@{
    ViewData["Title"] = "Đặt lịch dịch vụ";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <link rel="stylesheet" href="@Url.Content("~/css/booking.css")" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
}

<section class="make_apppointment_area">
    <div class="container">
        <div class="row g-4">
            <!-- Bên trái: Appointment Form -->
            <div class="col-lg-8">
                <div class="appoint_ment_form">
                    <h3 class="mb-4 text-center" id="booking-title" style="color:#2563eb;font-weight:700;">Đặt Lịch Dịch Vụ</h3>
                    <div class="booking-container">
                        <!-- Progress Indicator -->
                        <div class="progress-steps mb-4">
                            <div class="step active" data-step="1">
                                <div class="step-icon">1</div>
                                <span class="step-label">Chọn dịch vụ</span>
                            </div>
                            <div class="step" data-step="2">
                                <div class="step-icon">2</div>
                                <span class="step-label">Điền thông tin</span>
                            </div>
                            <div class="step" data-step="3">
                                <div class="step-icon">3</div>
                                <span class="step-label">Xác nhận</span>
                            </div>
                        </div>

                        <!-- Step Content -->
                        <div class="booking-steps">
                            <!-- Step 1: Choose Services -->
                            <div class="booking-step active" data-step="1">
                                <!-- Category Filter -->
                                <div class="filter-container">
                                    <div class="category-group active">
                                        <button class="filter-btn active" data-category="all">
                                            <i class="fa fa-th-large"></i> Tất cả
                                        </button>
                                        @foreach (var cat in Model.Categories)
                                        {
                                            <button class="filter-btn" data-category="@cat.CategoryId">
                                                <i class="fa fa-paw"></i> @cat.Name
                                            </button>
                                        }
                                    </div>
                                </div>
                                <!-- Service Grid -->
                                <div class="service-container">
                                    <div class="service-grid active" id="services">
                                        @foreach (var service in Model.Services)
                                        {
                                            <div class="service-card" data-category="@service.CategoryId">
                                                <div class="card-header">
                                                    <div class="service-icon">
                                                        <i class="fa fa-paw"></i>
                                                    </div>
                                                    <div class="service-info">
                                                        <h4>@service.Name</h4>
                                                        <div class="meta">
                                                            <span><i class="fa fa-clock-o"></i> @service.DurationMinutes phút</span>
                                                            <span class="price">@service.Price.ToString("N0") đ</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="card-body">
                                                    <ul class="features">
                                                        <li><i class="fa fa-check"></i> @service.Description</li>
                                                    </ul>
                                                </div>
                                                <div class="card-footer">
                                                    <button class="btn-select" data-service="@service.ServiceId" data-name="@service.Name" data-price="@service.Price">
                                                        <i class="fa fa-plus"></i> Chọn
                                                    </button>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>

                            <!-- Step 2: Customer Information -->
                            <div class="booking-step" data-step="2" style="display:none;">
                                <div class="customer-form">
                                    <h3 class="text-center mb-4" style="color:#2563eb;">Thông tin khách hàng</h3>
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label>Họ và tên</label>
                                            <input type="text" class="form-control" required>
                                        </div>
                                        <div class="form-group">
                                            <label>Số điện thoại</label>
                                            <input type="tel" class="form-control" required>
                                        </div>
                                        <div class="form-group">
                                            <label>Email</label>
                                            <input type="email" class="form-control">
                                        </div>
                                        <div class="form-group">
                                            <label>Ngày hẹn</label>
                                            <input type="date" class="form-control" required>
                                        </div>
                                        <div class="form-group">
                                            <label>Giờ hẹn</label>
                                            <input type="time" class="form-control" required>
                                        </div>
                                        <div class="form-section pet-selection">
                                            <h4>Chọn thú cưng của bạn</h4>
                                            <div class="pet-list">
                                                @foreach (var pet in Model.Pets)
                                                {
                                                    <div class="pet-item">
                                                        <input type="checkbox" id="pet-@pet.PetId" name="pets[]" value="@pet.PetId" class="pet-checkbox">
                                                        <label for="pet-@pet.PetId" class="pet-card">
                                                            <div class="pet-avatar">
                                                                <i class="fa fa-paw"></i>
                                                            </div>
                                                            <div class="pet-info">
                                                                <h5>@pet.Name</h5>
                                                                <span class="pet-breed">@pet.Breed</span>
                                                            </div>
                                                        </label>
                                                    </div>
                                                }
                                            </div>
                                            <button type="button" class="btn btn-outline-primary btn-sm mt-2" data-bs-toggle="modal" data-bs-target="#addPetModal">
                                                <i class="fa fa-plus"></i> Thêm thú cưng mới
                                            </button>
                                            <!-- Modal thêm thú cưng -->
                                            <div class="modal fade" id="addPetModal" tabindex="-1" aria-labelledby="addPetModalLabel" aria-hidden="true">
                                              <div class="modal-dialog">
                                                <div class="modal-content">
                                                  <form id="addPetForm">
                                                    <div class="modal-header">
                                                      <h5 class="modal-title" id="addPetModalLabel">Thêm thú cưng mới</h5>
                                                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                                                    </div>
                                                    <div class="modal-body">
                                                      <div class="mb-3">
                                                        <label for="petName" class="form-label">Tên thú cưng</label>
                                                        <input type="text" class="form-control" id="petName" required>
                                                      </div>
                                                      <div class="mb-3">
                                                        <label for="petBreed" class="form-label">Giống loài</label>
                                                        <input type="text" class="form-control" id="petBreed" required>
                                                      </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                                                      <button type="submit" class="btn btn-primary">Thêm</button>
                                                    </div>
                                                  </form>
                                                </div>
                                              </div>
                                            </div>
                                        </div>
                                        
                                        <div class="form-group full-width">
                                            <label>Ghi chú</label>
                                            <textarea class="form-control" rows="3"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 3: Confirmation -->
                            <div class="booking-step" data-step="3" style="display:none;">
                                <div class="confirmation-content">
                                    <h3 class="mb-3 text-center" style="color:#2563eb;">Đặt lịch thành công!</h3>
                                    <div class="confirmation-details">
                                        <p><strong>Dịch vụ:</strong> <span id="confirm-service"></span></p>
                                        <ul id="selected-services-list-step-3"></ul>
                                        <p><strong>Thú cưng:</strong> <span id="confirm-pet"></span></p>
                                        <p><strong>Thời gian:</strong> <span id="confirm-time"></span></p>
                                        <p>Cảm ơn bạn đã tin tưởng dịch vụ của chúng tôi!</p>
                                    </div>
                                    <div id="booking-confirmation" class="booking-confirmation"></div>
                                    <button class="btn btn-primary" onclick="window.location.reload()">Đặt lịch mới</button>
                                </div>
                            </div>
                        </div>

                        <!-- Navigation Buttons -->
                        <div class="booking-navigation mt-3">
                            <button class="btn btn-outline-secondary btn-prev" disabled>
                                <i class="fa fa-arrow-left"></i> Quay lại
                            </button>
                            <button class="btn btn-primary btn-next">
                                Tiếp tục <i class="fa fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Bên phải: Sidebar dịch vụ đã chọn -->
            <div class="col-lg-4">
                <aside class="appointMent_info shadow-sm rounded bg-white p-3 mb-4">
                    <div class="single_appontment">
                        <h5 class="mb-3 text-primary"><i class="fa fa-shopping-basket"></i> Dịch vụ đã chọn</h5>
                        <ul id="selected-services-sidebar" class="list-group mb-3">
                            <!-- Danh sách dịch vụ sẽ được cập nhật động bằng JS -->
                        </ul>
                        <div class="d-flex justify-content-between align-items-center border-top pt-2 mt-2">
                            <span class="fw-bold">Tổng tiền:</span>
                            <span id="selected-services-total" class="fs-5 text-danger fw-bold">0 đ</span>
                        </div>
                    </div>
                </aside>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script src="@Url.Content("~/js/booking.js")"></script>
    <script>
        // Sidebar cập nhật dịch vụ đã chọn
        function updateSelectedServicesSidebar(selectedServices) {
            var $list = $('#selected-services-sidebar');
            var total = 0;
            $list.empty();
            selectedServices.forEach(function(sv) {
                $list.append('<li class="list-group-item d-flex justify-content-between align-items-center">'
                    + '<span><i class="fa fa-check-circle text-success me-2"></i>' + sv.name + '</span>'
                    + '<span class="badge bg-primary rounded-pill">' + sv.price.toLocaleString() + ' đ</span></li>');
                total += sv.price;
            });
            $('#selected-services-total').text(total.toLocaleString() + ' đ');
        }
        // TODO: Thêm JS điều hướng các bước, chọn dịch vụ, validate form...
    </script>
    <script>
document.addEventListener('DOMContentLoaded', function () {
    // Thêm thú cưng mới vào danh sách
    document.getElementById('addPetForm').addEventListener('submit', function(e) {
        e.preventDefault();
        var name = document.getElementById('petName').value.trim();
        var breed = document.getElementById('petBreed').value.trim();
        if (!name || !breed) return;

        var petId = 'pet-' + Date.now();
        var petList = document.querySelector('.pet-list');
        var div = document.createElement('div');
        div.className = 'pet-item';
        div.innerHTML = `
            <input type="checkbox" id="${petId}" name="pets[]" value="${petId}" class="pet-checkbox" checked>
            <label for="${petId}" class="pet-card">
                <div class="pet-avatar"><i class="fa fa-paw"></i></div>
                <div class="pet-info">
                    <h5>${name}</h5>
                    <span class="pet-breed">${breed}</span>
                </div>
            </label>
        `;
        petList.appendChild(div);

        // Đóng modal
        var modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('addPetModal'));
        modal.hide();
        this.reset();

        // Gắn lại sự kiện cho checkbox mới
        div.querySelector('.pet-checkbox').addEventListener('change', updatePetCounter);
        // Nếu có hàm updateSelectedPetsList thì gọi luôn
        if (typeof updateSelectedPetsList === 'function') updateSelectedPetsList();
        updatePetCounter();
    });

    // Đếm số thú cưng đã chọn
    function updatePetCounter() {
        var checked = document.querySelectorAll('.pet-checkbox:checked').length;
        var counter = document.querySelector('.pet-counter .count');
        if (counter) counter.textContent = checked;
    }
    document.querySelectorAll('.pet-checkbox').forEach(function (cb) {
        cb.addEventListener('change', updatePetCounter);
    });
    updatePetCounter();
});
</script>
}
