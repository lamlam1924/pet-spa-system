@model pet_spa_system1.ViewModels.ServiceViewModel
@{
    ViewData["Title"] = "Quản lý dịch vụ";
    ViewData["SubTitle"] = "Danh sách dịch vụ";
    Layout = "~/Views/Admin/_LayoutAdmin.cshtml";
    
    var currentFilter = Context.Request.Query["search"].ToString();
    var currentSort = Context.Request.Query["sort"].ToString() ?? "name_asc";
    var currentStatus = Context.Request.Query["status"].ToString();
    var selectedCategoryId = Context.Request.Query["categoryId"].ToString();
    
    // Hardcode ảnh mặc định cho admin service
    var defaultImages = new string[] { 
        "/images/services/grooming.jpg", 
        "/images/services/bath.jpg", 
        "/images/services/nail.jpg", 
        "/images/services/healthcare.jpg",
        "/images/services/massage.jpg"
    };
    
    // Calculate pagination manually - use all services for total count
    var page = int.TryParse(Context.Request.Query["page"], out var p) ? p : 1;
    var itemsPerPage = 10;
    var allServices = Model.Services?.ToList() ?? new List<pet_spa_system1.Models.Service>();
    var totalItems = allServices.Count;
    var totalPages = (int)Math.Ceiling((double)totalItems / itemsPerPage);
    
    // Apply pagination to the services
    var currentPageServices = allServices
        .Skip((page - 1) * itemsPerPage)
        .Take(itemsPerPage)
        .ToList();
}

@section Styles {
    <link rel="stylesheet" href="~/cssjsService/css/service-common.css" />
    <link rel="stylesheet" href="~/cssjsService/css/service-list.css" />
}

<div class="container-fluid" id="container-wrapper">
    @await Html.PartialAsync("~/Views/Admin/ManageService/ServiceNav.cshtml")

    <!-- Header với actions nhanh -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h6 class="mb-1">Quản lý dịch vụ</h6>
                <p class="mb-0">
                    <span id="resultCount">@totalItems</span> dịch vụ
                    @if (!string.IsNullOrEmpty(currentFilter))
                    {
                        <span>cho "@currentFilter"</span>
                    }
                </p>
            </div>
            <div class="d-flex gap-2">
                <a href="@Url.Action("AddService", "AdminService")" class="btn btn-primary btn-sm px-3">
                    <i class="fas fa-plus me-2"></i> Thêm dịch vụ
                </a>
                <!-- Sửa thành id -->
                
                @* <button type="button" class="btn btn-outline-secondary btn-sm" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i>
                </button> *@
            </div>
        </div>
    </div>

    <!-- Bộ lọc được cải thiện -->
    <div class="filter-section">
        <div class="card shadow-sm mb-4">
            <div class="card-body p-3">
                <form method="get" action="@Url.Action("ServiceList", "AdminService")" id="filterForm">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <div class="search-box position-relative">
                                <input type="text" 
                                       class="form-control form-control-sm ps-4" 
                                       name="search" 
                                       value="@currentFilter" 
                                       placeholder="Tìm theo tên dịch vụ..."
                                       id="searchInput">
                                <i class="fas fa-search position-absolute search-icon"></i>
                                @if (!string.IsNullOrEmpty(currentFilter))
                                {
                                    <button type="button" class="btn-clear position-absolute" id="clearSearch">
                                        <i class="fas fa-times"></i>
                                    </button>
                                }
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select form-select-sm" name="categoryId" id="categoryFilter">
                                <option value="">Tất cả danh mục</option>
                                @if (ViewBag.Categories != null)
                                {
                                    foreach (var category in ViewBag.Categories)
                                    {
                                        var isSelected = selectedCategoryId == category.CategoryId.ToString();
                                        <option value="@category.CategoryId" selected="@isSelected">
                                            @category.Name
                                        </option>
                                    }
                                }
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select form-select-sm" name="status" id="statusFilter">
                                <option value="">Tất cả trạng thái</option>
                                <option value="active" selected="@(currentStatus == "active")">Hoạt động</option>
                                <option value="inactive" selected="@(currentStatus == "inactive")">Tạm ngưng</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary btn-sm flex-fill">
                                    <i class="fas fa-filter me-1"></i> Lọc
                                </button>
                                @if (!string.IsNullOrEmpty(currentFilter) || !string.IsNullOrEmpty(currentStatus) || !string.IsNullOrEmpty(selectedCategoryId))
                                {
                                    <a href="@Url.Action("ServiceList", "AdminService")" class="btn btn-outline-secondary btn-sm">
                                        <i class="fas fa-times"></i>
                                    </a>
                                }
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bảng dữ liệu được tối ưu -->
    <div class="table-card">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="serviceTable">
                <thead class="table-light">
                    <tr>
                        <!-- Loại bỏ cột ID không cần thiết -->
                        <th class="ps-4" style="width: 40%;">
                            <a href="@Url.Action("ServiceList", "AdminService", new { 
                                search = currentFilter, 
                                status = currentStatus, 
                                categoryId = selectedCategoryId,
                                sort = currentSort == "name_asc" ? "name_desc" : "name_asc" 
                            })" class="text-decoration-none text-dark fw-bold">
                                Tên dịch vụ
                                @if (currentSort == "name_asc")
                                {
                                    <i class="fas fa-sort-up ms-1"></i>
                                }
                                else if (currentSort == "name_desc")
                                {
                                    <i class="fas fa-sort-down ms-1"></i>
                                }
                                else
                                {
                                    <i class="fas fa-sort ms-1 text-muted"></i>
                                }
                            </a>
                        </th>
                        <th style="width: 15%;">Danh mục</th>
                        <th class="text-end" style="width: 15%;">
                            <a href="@Url.Action("ServiceList", "AdminService", new { 
                                search = currentFilter, 
                                status = currentStatus, 
                                categoryId = selectedCategoryId,
                                sort = currentSort == "price_asc" ? "price_desc" : "price_asc" 
                            })" class="text-decoration-none text-dark fw-bold">
                                Giá
                                @if (currentSort == "price_asc")
                                {
                                    <i class="fas fa-sort-up ms-1"></i>
                                }
                                else if (currentSort == "price_desc")
                                {
                                    <i class="fas fa-sort-down ms-1"></i>
                                }
                                else
                                {
                                    <i class="fas fa-sort ms-1 text-muted"></i>
                                }
                            </a>
                        </th>
                        <th class="text-center" style="width: 10%;">Trạng thái</th>
                        <th class="text-center pe-4" style="width: 20%;">Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @if (currentPageServices != null && currentPageServices.Any())
                    {
                        foreach (var service in currentPageServices)
                        {
                            var serviceImage = defaultImages[service.ServiceId % defaultImages.Length];
                            <tr class="service-row" data-service-id="@service.ServiceId">
                                <td class="ps-4">
                                    <div class="d-flex align-items-center">
                                        <div class="service-image-container">
                                            <img src="@serviceImage" 
                                                 alt="@service.Name" 
                                                 class="service-thumb"
                                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                            <div class="service-thumb-placeholder" style="display: none;">
                                                <i class="fas fa-briefcase"></i>
                                            </div>
                                        </div>
                                        <div class="service-content">
                                            <a href="@Url.Action("ServiceDetail", "AdminService", new { id = service.ServiceId })" 
                                               class="service-name">
                                                @service.Name
                                            </a>
                                            @if (!string.IsNullOrEmpty(service.Description) && service.Description.Length > 50)
                                            {
                                                <div class="service-desc">
                                                    @(service.Description.Length > 80 ? service.Description.Substring(0, 77) + "..." : service.Description)
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    @if (service.Category?.Name != null)
                                    {
                                        <span class="badge badge-category">@service.Category.Name</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">—</span>
                                    }
                                </td>
                                <td class="text-end">
                                    <span class="fw-bold text-primary">
                                        @{
                                            string priceText = "";
                                            if (service.Price >= 1000000)
                                            {
                                                priceText = (service.Price / 1000000).ToString("0.#") + "M VNĐ";
                                            }
                                            else
                                            {
                                                priceText = service.Price.ToString("N0") + " VNĐ";
                                            }
                                        }
                                        @priceText
                                    </span>
                                </td>
                                <td class="text-center">
                                    @if (service.IsActive == true)
                                    {
                                        <span class="badge badge-success">
                                            <i class="fas fa-check-circle me-1"></i> Hoạt động
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge badge-danger">
                                            <i class="fas fa-pause-circle me-1"></i> Tạm ngưng
                                        </span>
                                    }
                                </td>
                                <td class="text-center pe-4">
                                    <div class="action-buttons">
                                        <a href="@Url.Action("ServiceDetail", "AdminService", new { id = service.ServiceId })" 
                                           class="btn btn-outline-primary" 
                                           data-toggle="tooltip" 
                                           title="Xem chi tiết">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="@Url.Action("EditService", "AdminService", new { id = service.ServiceId })" 
                                           class="btn btn-outline-secondary"
                                           data-toggle="tooltip" 
                                           title="Chỉnh sửa">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        @if (service.IsActive == true)
                                        {
                                            <button type="button" 
                                                    class="btn btn-outline-warning btn-status-toggle"
                                                    data-service-id="@service.ServiceId"
                                                    data-current-status="true"
                                                    data-toggle="tooltip" 
                                                    title="Tạm ngưng">
                                                <i class="fas fa-pause"></i>
                                            </button>
                                        }
                                        else
                                        {
                                            <button type="button" 
                                                    class="btn btn-outline-success btn-status-toggle"
                                                    data-service-id="@service.ServiceId"
                                                    data-current-status="false"
                                                    data-toggle="tooltip" 
                                                    title="Kích hoạt">
                                                <i class="fas fa-play"></i>
                                            </button>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="5" class="text-center py-5">
                                <div class="empty-state">
                                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                                    <h6 class="text-muted">Không tìm thấy dịch vụ nào</h6>
                                    <p class="text-muted">Thử thay đổi bộ lọc hoặc tìm kiếm với từ khóa khác</p>
                                    <a href="@Url.Action("AddService", "AdminService")" class="btn btn-primary btn-sm">
                                        <i class="fas fa-plus me-1"></i> Thêm dịch vụ mới
                                    </a>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination được đơn giản hóa -->
    <div class="pagination-container">
        @if (totalPages > 1)
        {
            <div class="d-flex justify-content-between align-items-center mt-4">
                <div class="text-muted small">
                    @{
                        var startItem = (page - 1) * itemsPerPage + 1;
                        var endItem = Math.Min(page * itemsPerPage, totalItems);
                    }
                    Hiển thị @startItem - @endItem trong tổng số @totalItems dịch vụ
                </div>
                <nav>
                    <ul class="pagination pagination-sm mb-0">
                        @if (page > 1)
                        {
                            <li class="page-item">
                                <a class="page-link" href="@Url.Action("ServiceList", "AdminService", new { 
                                    search = currentFilter, 
                                    status = currentStatus, 
                                    categoryId = selectedCategoryId,
                                    sort = currentSort,
                                    page = page - 1 
                                })">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                            </li>
                        }
                        
                        @{
                            var startPage = Math.Max(1, page - 2);
                            var endPage = Math.Min(totalPages, page + 2);
                        }
                        
                        @for (int i = startPage; i <= endPage; i++)
                        {
                            <li class="page-item @(i == page ? "active" : "")">
                                <a class="page-link" href="@Url.Action("ServiceList", "AdminService", new { 
                                    search = currentFilter, 
                                    status = currentStatus, 
                                    categoryId = selectedCategoryId,
                                    sort = currentSort,
                                    page = i 
                                })">@i</a>
                            </li>
                        }
                        
                        @if (page < totalPages)
                        {
                            <li class="page-item">
                                <a class="page-link" href="@Url.Action("ServiceList", "AdminService", new { 
                                    search = currentFilter, 
                                    status = currentStatus, 
                                    categoryId = selectedCategoryId,
                                    sort = currentSort,
                                    page = page + 1 
                                })">
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        }
                    </ul>
                </nav>
            </div>
        }
    </div>

    <!-- Form ẩn để thay đổi trạng thái -->
    <form id="statusToggleForm" method="post" action="" style="display: none;">
        @Html.AntiForgeryToken()
        <input type="hidden" name="serviceId" id="statusServiceId" />
    </form>
</div>

@section Scripts {
    <!-- BỎ DÒNG NÀY - DUPLICATE JQUERY -->
    @* <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> *@
    
    <!-- Giữ lại -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="~/cssjsService/js/service-list.js"></script>
    <script>
        // Configuration for JavaScript
        var activateUrl = '@Url.Action("RestoreService", "AdminService")';
        var deactivateUrl = '@Url.Action("SoftDeleteService", "AdminService")';
        
        var successMessage = '@(TempData["SuccessMessage"]?.ToString() ?? "")';
        var errorMessage = '@(TempData["ErrorMessage"]?.ToString() ?? "")';
        
        console.log('Script variables loaded:');
        console.log('successMessage:', successMessage);
        console.log('errorMessage:', errorMessage);
    </script>
}
