@model List<pet_spa_system1.Models.SerCate>
@{
    ViewData["Title"] = "Quản lý danh mục dịch vụ";
    Layout = "~/Views/Admin/_LayoutAdmin.cshtml";
}

@section Styles {
    <style>
        .category-card {
            transition: all 0.3s;
            border-left: 3px solid #36b9cc;
        }
        .category-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .category-card.inactive {
            border-left: 3px solid #e74a3b;
            opacity: 0.8;
        }
        .category-count {
            background-color: #36b9cc;
            color: white;
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.75rem;
        }
        .category-actions {
            visibility: visible;
            transition: all 0.2s;
            opacity: 0.7;
        }
        .category-card:hover .category-actions {
            opacity: 1;
        }
        .sortable-ghost {
            background-color: #f8f9fc;
            border: 2px dashed #4e73df;
        }
        .sortable-drag {
            opacity: 0.8;
        }
        .sortable-handle {
            cursor: move;
            color: #858796;
        }
        .sortable-handle:hover {
            color: #4e73df;
        }
        .category-description {
            color: #858796;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            white-space: pre-line;
        }
        .chart-container {
            position: relative;
            height: 300px;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.css" />
}

<div class="container-fluid" id="container-wrapper">
    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Quản lý danh mục dịch vụ</h1>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="@Url.Action("Index", "Admin")">Trang chủ</a></li>
            <li class="breadcrumb-item"><a href="@Url.Action("ServiceList", "Admin")">Dịch vụ</a></li>
            <li class="breadcrumb-item active" aria-current="page">Danh mục</li>
        </ol>
    </div>

    <div class="row">
        <!-- Danh sách danh mục -->
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Danh sách danh mục dịch vụ</h6>
                    <div class="dropdown no-arrow">
                        <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                        </a>
                        <div class="dropdown-menu dropdown-menu-right shadow animated--fade-in" aria-labelledby="dropdownMenuLink">
                            <div class="dropdown-header">Tùy chọn:</div>
                            <a class="dropdown-item" href="@Url.Action("ServiceCategory", "Admin")">
                                <i class="fas fa-sync fa-sm fa-fw mr-2 text-gray-400"></i> Làm mới
                            </a>
                            <a class="dropdown-item" href="#" id="btnSaveOrder">
                                <i class="fas fa-save fa-sm fa-fw mr-2 text-gray-400"></i> Lưu thứ tự
                            </a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addCategoryModal">
                            <i class="fas fa-plus-circle"></i> Thêm danh mục mới
                        </button>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Kéo và thả các danh mục để sắp xếp thứ tự hiển thị. Nhấn "Lưu thứ tự" sau khi hoàn tất.
                    </div>

                    @if (Model != null && Model.Any())
                    {
                        <div id="sortableCategoryList">
                            @foreach (var category in Model)
                            {
                                <div class="card mb-3 @(category.IsActive == true ? "category-card" : "category-card inactive")" data-id="@category.CategoryId">
                                    <div class="card-body py-3">
                                        <div class="row align-items-center">
                                            <div class="col-auto">
                                                <span class="sortable-handle">
                                                    <i class="fas fa-grip-vertical fa-lg"></i>
                                                </span>
                                            </div>
                                            <div class="col">
                                                <h6 class="font-weight-bold mb-1 text-primary">
                                                    @category.Name
                                                    <span class="category-count ml-2">
                                                        @(ViewBag.ServiceCounts != null && ViewBag.ServiceCounts.ContainsKey(category.CategoryId) 
                                                            ? ViewBag.ServiceCounts[category.CategoryId] : 0) dịch vụ
                                                    </span>
                                                </h6>
                                                <div class="category-description">
                                                    @(string.IsNullOrEmpty(category.Description) ? "Không có mô tả" : category.Description)
                                                </div>
                                                <small class="text-muted">
                                                    @(category.IsActive == true ? "Đang hoạt động" : "Tạm ngưng")
                                                </small>
                                            </div>
                                            <div class="col-auto category-actions">
                                                <button type="button" class="btn btn-sm btn-primary btn-edit-category" 
                                                        data-id="@category.CategoryId"
                                                        data-name="@category.Name"
                                                        data-description="@category.Description"
                                                        data-is-active="@category.IsActive">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button type="button" class="btn btn-sm btn-danger btn-delete-category"
                                                        data-id="@category.CategoryId" 
                                                        data-name="@category.Name"
                                                        data-count="@(ViewBag.ServiceCounts != null && ViewBag.ServiceCounts.ContainsKey(category.CategoryId) 
                                                                    ? ViewBag.ServiceCounts[category.CategoryId] : 0)">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> Chưa có danh mục dịch vụ nào. Vui lòng tạo danh mục mới.
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Thống kê danh mục -->
        <div class="col-lg-4">
            <!-- Biểu đồ phân bố -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Phân bố dịch vụ theo danh mục</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="categoryDistributionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Tóm tắt thông tin -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Tóm tắt thông tin</h6>
                </div>
                <div class="card-body">
                    <div class="row align-items-center mb-3">
                        <div class="col">
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.Count()</div>
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Tổng số danh mục</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-folder fa-2x text-gray-300"></i>
                        </div>
                    </div>
                    <div class="row align-items-center mb-3">
                        <div class="col">
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.Count(c => c.IsActive == true)</div>
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Danh mục hoạt động</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-success"></i>
                        </div>
                    </div>
                    <div class="row align-items-center mb-3">
                        <div class="col">
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.Count(c => c.IsActive != true)</div>
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Danh mục tạm ngưng</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-ban fa-2x text-danger"></i>
                        </div>
                    </div>
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                @(ViewBag.ServiceCounts?.Values.Sum() ?? 0)
                            </div>
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Tổng số dịch vụ</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-spa fa-2x text-info"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Nút quay lại -->
            <a href="@Url.Action("ServiceList", "Admin")" class="btn btn-secondary btn-block mb-4">
                <i class="fas fa-arrow-left"></i> Quay lại danh sách dịch vụ
            </a>
        </div>
    </div>
</div>

<!-- Modal Thêm Danh Mục -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCategoryModalLabel">Thêm danh mục mới</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="addCategoryForm" asp-action="AddServiceCategory" method="post">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="Name" class="form-label">Tên danh mục <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="categoryName" name="Name" required 
                               placeholder="Nhập tên danh mục">
                    </div>
                    <div class="form-group">
                        <label for="Description" class="form-label">Mô tả</label>
                        <textarea class="form-control" id="categoryDescription" name="Description" rows="3"
                                  placeholder="Mô tả chi tiết về danh mục"></textarea>
                    </div>
                    <div class="form-group">
                        <div class="custom-control custom-switch">
                            <input type="checkbox" class="custom-control-input" id="categoryIsActive" name="IsActive" checked>
                            <label class="custom-control-label" for="categoryIsActive">Kích hoạt danh mục</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary">Thêm danh mục</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Sửa Danh Mục -->
<div class="modal fade" id="editCategoryModal" tabindex="-1" aria-labelledby="editCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCategoryModalLabel">Sửa danh mục</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="editCategoryForm" asp-action="UpdateServiceCategory" method="post">
                <input type="hidden" id="editCategoryId" name="CategoryId">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="editName" class="form-label">Tên danh mục <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editCategoryName" name="Name" required 
                               placeholder="Nhập tên danh mục">
                    </div>
                    <div class="form-group">
                        <label for="editDescription" class="form-label">Mô tả</label>
                        <textarea class="form-control" id="editCategoryDescription" name="Description" rows="3"
                                  placeholder="Mô tả chi tiết về danh mục"></textarea>
                    </div>
                    <div class="form-group">
                        <div class="custom-control custom-switch">
                            <input type="checkbox" class="custom-control-input" id="editCategoryIsActive" name="IsActive">
                            <label class="custom-control-label" for="editCategoryIsActive">Kích hoạt danh mục</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Xác nhận xóa -->
<div class="modal fade" id="deleteCategoryModal" tabindex="-1" aria-labelledby="deleteCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteCategoryModalLabel">Xác nhận xóa danh mục</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc chắn muốn xóa danh mục "<span id="deleteCategoryName"></span>"?</p>
                <div id="categoryHasServices" class="alert alert-warning" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i> Danh mục này đang có <strong><span id="serviceCount"></span></strong> dịch vụ.
                    Bạn cần chuyển các dịch vụ sang danh mục khác hoặc xóa trước khi có thể xóa danh mục này.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                <form id="deleteCategoryForm" asp-action="DeleteServiceCategory" method="post">
                    <input type="hidden" id="deleteCategoryId" name="id">
                    <button type="submit" id="btnConfirmDelete" class="btn btn-danger">Xác nhận xóa</button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
    <script>
        $(document).ready(function() {
            // Khởi tạo Sortable
            var sortable = new Sortable(document.getElementById('sortableCategoryList'), {
                animation: 150,
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag',
                handle: '.sortable-handle'
            });
            
            // Xử lý nút lưu thứ tự
            $('#btnSaveOrder').on('click', function() {
                // Lấy thứ tự hiện tại
                var categories = [];
                $('.category-card').each(function(index) {
                    categories.push({
                        CategoryId: parseInt($(this).data('id')),
                        DisplayOrder: index + 1
                    });
                });
                
                // Gửi AJAX request để cập nhật thứ tự
                $.ajax({
                    url: '@Url.Action("UpdateCategoryOrder", "Admin")',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(categories),
                    success: function(response) {
                        if (response.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Thành công',
                                text: response.message,
                                timer: 2000,
                                timerProgressBar: true
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Lỗi',
                                text: response.message
                            });
                        }
                    },
                    error: function() {
                        Swal.fire({
                            icon: 'error',
                            title: 'Lỗi',
                            text: 'Đã xảy ra lỗi khi cập nhật thứ tự danh mục.'
                        });
                    }
                });
            });
            
            // Xử lý nút chỉnh sửa danh mục
            $('.btn-edit-category').on('click', function() {
                var id = $(this).data('id');
                var name = $(this).data('name');
                var description = $(this).data('description');
                var isActive = $(this).data('is-active');
                
                $('#editCategoryId').val(id);
                $('#editCategoryName').val(name);
                $('#editCategoryDescription').val(description);
                $('#editCategoryIsActive').prop('checked', isActive === 'True');
                
                $('#editCategoryModal').modal('show');
            });
            
            // Xử lý nút xóa danh mục
            $('.btn-delete-category').on('click', function() {
                var id = $(this).data('id');
                var name = $(this).data('name');
                var count = parseInt($(this).data('count'));
                
                $('#deleteCategoryId').val(id);
                $('#deleteCategoryName').text(name);
                
                if (count > 0) {
                    $('#serviceCount').text(count);
                    $('#categoryHasServices').show();
                    $('#btnConfirmDelete').prop('disabled', true);
                } else {
                    $('#categoryHasServices').hide();
                    $('#btnConfirmDelete').prop('disabled', false);
                }
                
                $('#deleteCategoryModal').modal('show');
            });
            
            // Hiển thị biểu đồ phân bố
            var ctx = document.getElementById('categoryDistributionChart').getContext('2d');
            var categoryDistributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [@Html.Raw(string.Join(", ", Model.Select(c => $"'{c.Name}'")))],
                    datasets: [{
                        data: [
                            @Html.Raw(string.Join(", ", 
                                Model.Select(c => 
                                    ViewBag.ServiceCounts != null && ViewBag.ServiceCounts.ContainsKey(c.CategoryId) 
                                        ? ViewBag.ServiceCounts[c.CategoryId] 
                                        : 0
                                )
                            ))
                        ],
                        backgroundColor: [
                            '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796',
                            '#6f42c1', '#20c9a6', '#5a5c69', '#2e59d9', '#17a673', '#2c9faf'
                        ],
                        hoverBackgroundColor: [
                            '#2e59d9', '#17a673', '#2c9faf', '#dda20a', '#be2617', '#6e707e',
                            '#5a33a0', '#169b80', '#444550', '#2246b1', '#128f60', '#25808e'
                        ],
                        hoverBorderColor: "rgba(234, 236, 244, 1)",
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    legend: {
                        display: true,
                        position: 'bottom',
                        labels: {
                            boxWidth: 12
                        }
                    },
                    tooltips: {
                        callbacks: {
                            label: function(tooltipItem, data) {
                                var dataset = data.datasets[tooltipItem.datasetIndex];
                                var currentValue = dataset.data[tooltipItem.index];
                                var percentage = Math.round((currentValue / dataset.data.reduce((a, b) => a + b, 0)) * 100);
                                return data.labels[tooltipItem.index] + ': ' + currentValue + ' dịch vụ (' + percentage + '%)';
                            }
                        }
                    },
                    cutoutPercentage: 60
                }
            });
            
            // Hiển thị thông báo nếu có
            @if (TempData["SuccessMessage"] != null)
            {
                <text>
                Swal.fire({
                    icon: 'success',
                    title: 'Thành công',
                    text: '@TempData["SuccessMessage"]',
                    timer: 3000,
                    timerProgressBar: true
                });
                </text>
            }
            
            @if (TempData["ErrorMessage"] != null)
            {
                <text>
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: '@TempData["ErrorMessage"]'
                });
                </text>
            }
        });
    </script>
}
