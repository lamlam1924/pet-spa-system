@model pet_spa_system1.ViewModels.ServiceDashboardViewModel
@{
    ViewData["Title"] = "Quản lý dịch vụ";
    ViewData["SubTitle"] = "Tổng quan";
    Layout = "~/Views/Admin/_LayoutAdmin.cshtml";
}

@section Styles {
    <link rel="stylesheet" href="~/cssjsService/css/service-common.css" />
    <link rel="stylesheet" href="~/cssjsService/css/service-dashboard.css" />
}

<div class="container-fluid" id="container-wrapper">
    <!-- Sử dụng partial view navigation chung -->
    @await Html.PartialAsync("~/Views/Admin/ManageService/ServiceNav.cshtml")

    <div class="row">
        <!-- Thống kê tổng quan -->
        <div class="col-xl-12 col-xxl-12 d-flex">
            <div class="w-100">
                <div class="row">
                    <div class="col-sm-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col mt-0">
                                        <h5 class="card-title">Tổng dịch vụ</h5>
                                    </div>
                                    <div class="col-auto">
                                        <div class="stat text-primary">
                                            <i class="fas fa-spa"></i>
                                        </div>
                                    </div>
                                </div>
                                <h1 class="mt-1 mb-3">@Model.TotalServices</h1>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-sm-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col mt-0">
                                        <h5 class="card-title">Dịch vụ hoạt động</h5>
                                    </div>
                                    <div class="col-auto">
                                        <div class="stat text-success">
                                            <i class="fas fa-check-circle"></i>
                                        </div>
                                    </div>
                                </div>
                                <h1 class="mt-1 mb-3">@Model.ActiveServices</h1>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col mt-0">
                                        <h5 class="card-title">Dịch vụ tạm ngưng</h5>
                                    </div>

                                    <div class="col-auto">
                                        <div class="stat text-primary">
                                            <i class="align-middle" data-feather="pause-circle"></i>
                                        </div>
                                    </div>
                                </div>
                                <h1 class="mt-1 mb-3">@Model.InactiveServices</h1> <!--✅ Sửa từ ViewBag thành Model-->
                                <div class="mb-0">
                                    <span class="badge badge-warning-light"> <i class="mdi mdi-arrow-bottom-right"></i> Đã tạm ngưng </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-3">
                        <div class="card">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col mt-0">
                                        <h5 class="card-title">Số lượng danh mục</h5>
                                    </div>

                                    <div class="col-auto">
                                        <div class="stat text-primary">
                                            <i class="align-middle" data-feather="folder"></i>
                                        </div>
                                    </div>
                                </div>
                                <h1 class="mt-1 mb-3">@Model.TotalCategories</h1> <!--✅ Sửa từ ViewBag thành Model-->
                                <div class="mb-0">
                                    <span class="badge badge-info-light"> <i class="mdi mdi-arrow-bottom-right"></i> Tổng danh mục </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Dịch vụ gần đây -->
        <div class="col-12 col-lg-8 d-flex">
            <div class="card flex-fill">
                <div class="card-header">
                    <h5 class="card-title mb-0">Dịch vụ mới thêm gần đây</h5>
                </div>
                <table class="table table-hover my-0">
                    <thead>
                        <tr>
                            <th>Tên dịch vụ</th>
                            <th class="d-none d-xl-table-cell">Danh mục</th>
                            <th class="d-none d-xl-table-cell">Ngày tạo</th>
                            <th>Giá</th>
                            <th class="d-none d-md-table-cell">Trạng thái</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.RecentServices?.Any() == true)
                        {
                            @foreach (var service in Model.RecentServices)
                            {
                                <tr>
                                    <td>
                                        <a href="@Url.Action("ServiceDetail", "AdminService", new { id = service.ServiceId })">
                                            @service.Name
                                        </a>
                                    </td>
                                    <!-- ✅ FIX: Lookup category name từ CategoryStats -->
                                    <td class="d-none d-xl-table-cell">
                                        @{
                                            var categoryName = Model.CategoryStats?.FirstOrDefault(c => c.CategoryId == service.CategoryId)?.CategoryName ?? "Chưa phân loại";
                                        }
                                        @categoryName
                                    </td>
                                    <td class="d-none d-xl-table-cell">@(service.CreatedAt?.ToString("dd/MM/yyyy") ?? "N/A")</td>
                                    <td>@service.Price.ToString("N0") đ</td>
                                    <td class="d-none d-md-table-cell">
                                        @if (service.IsActive == true)
                                        {
                                            <span class="badge bg-success">Hoạt động</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-danger">Tạm ngưng</span>
                                        }
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Biểu đồ hoặc thông tin khác -->
        <!-- ... (giữ nguyên phần này) ... -->
    </div>

    <div class="row">
        <!-- Biểu đồ phân bố dịch vụ -->
        <div class="col-12 col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Phân bố dịch vụ theo danh mục</h5>
                </div>
                <div class="card-body">
                    <div class="chart">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Biểu đồ khác -->
        <!-- ... (giữ nguyên phần này) ... -->
    </div>

    <!-- Top Services Section -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Top Dịch Vụ</h5>
                </div>
                <div class="card-body">
                    @if (Model.TopServices?.Any() == true)
                    {
                        <div class="recent-services">
                            @foreach (var service in Model.TopServices.Take(5))
                            {
                                <div class="service-item">
                                    <span>@service.ServiceName</span>
                                    <span>@service.BookingCount lượt đặt</span>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <p>Không có dịch vụ nào được liệt kê.</p>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Category Distribution Section -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Phân bố dịch vụ theo danh mục</h5>
                </div>
                <div class="card-body">
                    @if (Model.CategoryStats?.Any() == true)
                    {
                        <div class="category-distribution">
                            @foreach (var item in Model.CategoryStats)
                            {
                                <div class="category-item">
                                    <span>@item.CategoryName</span>
                                    <span>@item.ServiceCount dịch vụ</span>
                                    <span>@item.Percentage.ToString("F1")%</span>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <p>Không có dữ liệu phân bố danh mục.</p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Thư viện bên ngoài -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="~/cssjsService/js/service-common.js"></script>
    <script src="~/cssjsService/js/service-dashboard.js"></script>
    <script>
        // Biểu đồ phân bố danh mục
        document.addEventListener('DOMContentLoaded', function() {
            const categoryData = @Html.Raw(Json.Serialize(Model.CategoryDistribution));
            const ctx = document.getElementById('categoryChart').getContext('2d');
            
            // Tạo biểu đồ với dữ liệu từ Model
            const categoryChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.values(categoryData),
                    datasets: [{
                        data: Object.keys(categoryData),
                        backgroundColor: [
                            '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#6f42c1'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // Các biểu đồ khác tương tự
        });
    </script>
}
